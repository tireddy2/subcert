<?xml version="1.0" encoding="US-ASCII"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<!-- used by XSLT processors -->
<!-- For a complete list and description of processing instructions (PIs), 
     please see http://xml.resource.org/authoring/README.html. -->
<!-- Below are generally applicable Processing Instructions (PIs) that most I-Ds might want to use.
     (Here they are set differently than their defaults in xml2rfc v1.32) -->
<?rfc strict="yes" ?>
<!-- give errors regarding ID-nits and DTD validation -->
<!-- control the table of contents (ToC) -->
<?rfc toc="yes"?>
<!-- generate a ToC -->
<?rfc tocdepth="4"?>
<!-- the number of levels of subsections in ToC. default: 3 -->
<!-- control references -->
<?rfc symrefs="yes"?>
<!-- use symbolic references tags, i.e, [RFC2119] instead of [1] -->
<?rfc sortrefs="yes" ?>
<!-- sort the reference entries alphabetically -->
<!-- control vertical white space 
     (using these PIs as follows is recommended by the RFC Editor) -->
<?rfc compact="yes" ?>
<!-- do not start each main section on a new page -->
<?rfc subcompact="no" ?>
<!-- keep one blank line between list items -->
<!-- end of list of popular I-D processing instructions -->
<rfc category="info" docName="draft-reddy-add-delegated-credentials-00"
     ipr="trust200902" submissionType="independent">
  <front>
    <title abbrev="Delegated Credentials for encrypted DNS ">Delegated
    credentials to host encrypted DNS forwarders on CPEs</title>

    <author fullname="Tirumaleswar Reddy" initials="T." surname="Reddy">
      <organization>Nokia</organization>

      <address>
        <postal>
          <street></street>

          <city></city>

          <region></region>

          <code></code>

          <country>India</country>
        </postal>

        <email>kondtir@gmail.com</email>
      </address>
    </author>

    <author fullname="Mohamed Boucadair" initials="M." surname="Boucadair">
      <organization>Orange</organization>

      <address>
        <postal>
          <street></street>

          <city>Rennes</city>

          <code>35000</code>

          <country>France</country>
        </postal>

        <email>mohamed.boucadair@orange.com</email>
      </address>
    </author>

    <author fullname="Dan Wing" initials="D." surname="Wing">
      <organization abbrev="Citrix">Citrix Systems, Inc.</organization>

      <address>
        <postal>
          <street></street>

          <country>USA</country>
        </postal>

        <email>dwing-ietf@fuggles.com</email>
      </address>
    </author>

    <author fullname="Neil Cook" initials="N." surname="Cook">
      <organization>Open-Xchange</organization>

      <address>
        <postal>
          <street></street>

          <country>UK</country>
        </postal>

        <email>neil.cook@noware.co.uk</email>
      </address>
    </author>

    <date />

    <abstract>
      <t>Typically, an encrypted DNS server is authenticated by a certificate
      signed by a Certificate Authority. However, in many deployements of an
      encrypted DNS server on Customer Premise Equipment (CPE) the signature
      cannot be obtained or is difficult for the operator of the CPE to
      scale.</t>

      <t>This document explores using TLS delegated credentials for a DNS
      server deployed as Customer Premise Equipment.</t>
    </abstract>
  </front>

  <middle>
    <section anchor="intro" title="Introduction">
      <t>The current challenges of hosting encrypted resolvers on CPEs is
      discussed in <xref target="forwarder"></xref>.</t>

      <t>This document discusses using delegated credentias <xref
      target="I-D.ietf-tls-subcerts"></xref> to host encrypted DNS resolvers
      such as DoH <xref target="RFC8484"></xref>, DNS-over-TLS (DoT) <xref
      target="RFC7858"></xref>, or DNS-over-QUIC (DoQ) <xref
      target="RFC9250"></xref> in managed Customer Premises Equipment (CPEs)
      by reducing the dependency on Certification Authority (CA). The
      advantage of using delegated credentials on CPEs is that it completely
      removes the dependency on the CAs to provide an PKI certificate for each
      CPE. The entity managing the CPE (e..g, ISP, CPE vendor, Security
      Service Provider) will provision it a with a delegated credential and
      renew the delegated credential before the expiry.</t>
    </section>

    <section anchor="notation" title="Terminology">
      <t>This document makes use of the terms defined in <xref
      target="RFC8499"></xref>.</t>

      <t>The following additional terms are used: <list style="hanging">
          <t hangText="DHCP:">refers to both DHCPv4 and DHCPv6.</t>

          <t hangText="Do53:">refers to unencrypted DNS.</t>

          <t hangText="DNR:">refers to the Discovery of Network-designated
          Resolvers procedure defined in <xref
          target="I-D.ietf-add-dnr"></xref>.</t>

          <t hangText="DDR:">refers to the Discovery of Designated Resolvers
          procedure defined in <xref target="I-D.ietf-add-ddr"></xref>.</t>

          <t hangText="Encrypted DNS:">refers to a scheme where DNS exchanges
          are transported over an encrypted channel. Examples of encrypted DNS
          are DoH <xref target="RFC8484"></xref>, DNS-over-TLS (DoT) <xref
          target="RFC7858"></xref>, and DNS-over-QUIC (DoQ) <xref
          target="RFC9250"></xref>.</t>

          <t hangText="Managed CPE:">refers to a CPE that is managed by an ISP
          or CPE vendor or Security Service Provider.</t>

          <t hangText="Unmanaged CPE:">refers to a CPE that is not managed by
          an ISP or CPE vendor or Security Service Provider.</t>

          <t hangText="Delegated credential:">The certificate issued by the
          operator as described by <xref
          target="I-D.ietf-tls-subcerts"></xref>.</t>
        </list></t>
    </section>

    <section title="Scope">
      <t>Scope of this document is an encrypted DNS server deployed on a
      managed customer premise equipment.</t>
    </section>

    <section title="Current state of the art for Home Routers">
      <t>Home routers are a critical component of the home network, and their
      security is essential to protecting the devices and data that are
      connected to them. The prpl Foundation <xref target="prpl"></xref> has
      developed a number of initiatives to promote home router security and
      hardening. The prplWrt project <xref target="prplwrt"></xref> is an
      initiative in prpl Foundation that aims to improve the security and
      performance of open-source router firmware, such as OpenWrt <xref
      target="openwrt"></xref>. OpenWrt is an open-source operating system
      that is designed to run on a wide range of routers and embedded devices.
      It now includes support for containerization technology such as Docker,
      making it possible to run containerized applications on a home router.
      Further, DNS providers have optimized the encrypted DNS forwarder to run
      in a container in home routers.</t>
    </section>

    <section anchor="mcpe" title="Deployment of Managed CPE">
      <t>This section discusses deployment models for managed CPE.</t>

      <section title="Proxied DNS">
        <t><xref target="proxied"></xref> shows various network setups where
        the CPE embeds a caching encrypted DNS forwarder. <xref
        target="comp"></xref> discusses the applicability of DDR as a function
        of the address used by the CPE for the verification of ownership.</t>

        <t><figure align="center" anchor="proxied"
            title="Proxied Encrypted DNS Sessions">
            <artwork><![CDATA[(a)

                      ,--,--,--.             ,--,--,--.
                   ,-'          `-.       ,-'   ISP    `-.
           Host---(      LAN      CPE----(    DNS Resolver)
             |     `-.          ,-'|      `-.          ,-'
             |        `--'--'--'   |       | `--'--'--'
             |                     |<=DNR=>|     |
             |<========DNR========>|       |     |
             |                     |             | 
             |<=====Encrypted=====>|<=Encrypted=>| 
             |         DNS         |     DNS     | 

(b)

                ,--,--,--.             ,--,--,--.
             ,-'          `-.       ,-'   ISP    `-.      3rd Party
     Host---(      LAN      CPE----(                )--- DNS Resolver
       |     `-.          ,-'|      `-.          ,-'        |
       |        `--'--'--'   |       | `--'--'--'           |
       |                     |<=DNR=>|                      |
       |<========DNR========>|       |                      |
       |                     |                              | 
       |<=====Encrypted=====>|<=========Encrypted DNS======>| 
       |         DNS         |                              | 
]]></artwork>
          </figure></t>

        <t>For all the cases shown in <xref target="proxied"></xref>, the CPE
        advertises itself as the default DNS server to the hosts it serves in
        the LAN. The CPE relies upon DHCP or RA to advertise itself to
        internal hosts as the default encrypted DNS forwarder. When receiving
        a DNS request it cannot handle locally, the CPE forwards the request
        to an upstream encrypted DNS. The upstream encrypted DNS can be hosted
        by the ISP or provided by a third party.</t>

        <t>Such a forwarder presence is required for IPv4 service continuity
        purposes (e.g., Section 3.1 of <xref target="RFC8585"></xref>) or for
        supporting advanced services within a local network (e.g., malware
        filtering, parental control, Manufacturer Usage Description (MUD)
        <xref target="RFC8520"></xref> to only allow intended communications
        to and from an IoT device). When the CPE behaves as a DNS forwarder,
        DNS communications can be decomposed into two legs to resolve
        queries:<list style="symbols">
            <t>The leg between an internal host and the CPE.</t>

            <t>The leg between the CPE and an upstream DNS resolver.</t>
          </list></t>
      </section>
    </section>

    <section anchor="forwarder"
             title="Hosting Encrypted DNS Forwarder in Local Networks">
      <t>This section discusses some deployment challenges to host an
      encrypted DNS forwarder within a local network</t>

      <section anchor="comp" title="DDR/DNR Comparison and Naming Constraints">
        <t>DDR requires proving possession of an IP address, as the DDR
        certificate contains the server's IPv4 and IPv6 addresses and is
        signed by a certificate authority. DDR is constrained to public IP
        addresses because WebPKI certificate authorities will not sign
        special-purpose IP addresses <xref target="RFC6890"></xref>, most
        notably IPv4 private-use <xref target="RFC1918"></xref>, IPv4 shared
        address <xref target="RFC6598"></xref>, or IPv6 <xref
        target="RFC8190">Unique-Local</xref> address space. A tempting
        solution is to use the CPE's WAN IP address for DDR and prove
        possession of that IP address. However, the CPE's WAN IPv4 address
        will not be a public IPv4 address if the CPE is behind another layer
        of NAT (either Carrier Grade NAT (CGN) or another on-premise NAT),
        reducing the success of this mechanism to CPE's WAN IPv6 address. If
        the ISP renumbers the subscriber's network suddenly (rather than slow
        IPv6 renumbering described in <xref target="RFC4192"></xref>)
        encrypted DNS service will be delayed until that new certificate is
        acquired.</t>

        <t>DNR requires proving possession of an FQDN as the encrypted
        resolver's certificate contains the FQDN. The entity (e.g., ISP,
        network administrator) managing the CPE would assign a unique FQDN to
        the CPE. There are two mechanisms for the CPE to obtain the
        certificate for the FQDN: using one of its WAN IP addresses or
        requesting its signed certificate from an Internet-facing server used
        for remote CPE management (e.g., the Auto Configuration Server (ACS)
        in the CPE WAN Management Protocol <xref target="TR-069"></xref>). If
        using a CPE's WAN IP address, the CPE needs a public IPv4 or a global
        unicast IPv6 address together with DNS A or AAAA records pointing to
        that CPE's WAN address to prove possession of the DNS name to obtain a
        WebPKI CA-signed certificate (that is, the CPE fulfills the DNS or
        HTTP challenge discussed in ACME <xref target="RFC8555"></xref>).
        However, a CPE's WAN address will not be a public IPv4 address if the
        CPE is behind another layer of NAT (either a CGN or another on-premise
        NAT), reducing the success of this mechanism to a CPE's WAN IPv6
        address. If the subscribers IPv4 or IPv6 address is included in the
        certificate name (e.g., "dyn-192-0-2-1.example.net") then DNR will
        experience IP renumbering complications identical to DDR, described
        above. The former mechanism has the following limitations when ACME
        protocol is used for certificate issuance:<list style="symbols">
            <t>Each CPE would have to create a different account for ordering
            a certificate. When a large scale of CPEs (e.g., millions of
            devices) request certificate issuance for a large number of
            subdomains, it could be treated as an attacker by the certificate
            authorities to overwhelm it.</t>

            <t>The CPE would have to host an Internet-facing HTTP server or a
            DNS authoritative server to complete the HTTP or DNS
            challenge.</t>
          </list></t>
      </section>

      <section anchor="forwarder_m" title="Delegated certificate issuance">
        <t>The DoT/DoH forwarder is hosted on the CPE and provisioned by a
        service (e.g., Orchestrator) in the operator's network. Each CPE has a
        unique FQDN (e.g., cpe-12345.example.com where 12345 might be the
        customer number or part of the device's serial number). It is
        important that the FQDN is unique for each subscriber. The CPE
        generates a public and private key-pair, builds a certificate signing
        request (CSR), and sends the CSR to a service in the vendor managing
        the CPE. On receipt of the CSR, the operator's service can utilize
        Automatic Certificate Management Environment (ACME) <xref
        target="RFC8555"></xref> to automate certificate management functions
        such as domain validation procedure, certificate issuance, and
        certificate revocation.</t>

        <t>The challenge with this technique is the service will have to
        communicate with the CA to issue certificates for millions of CPEs. If
        an external CA is unable to issue a certificate in time or replace a
        expired certificate, the service would no longer be able to present a
        valid certificate to CPE. When the service requests certificate
        issuance for a large number of subdomains (i.e., millions of CPEs), it
        could be treated as an attacker by the certificate authorities to
        overwhelm it. Further, the short-lived certificates (e.g.,
        certificates that typically expire after 90 days) issued by the CA
        will have to be renewed frequently. With short-lived certificates,
        there is a smaller window of time to renew a certificates and
        therefore a higher risk that an outage at a CA will negatively affect
        the uptime of the encrypted DNS forwarders on CPEs.</t>
      </section>
    </section>

    <section anchor="delegated" title="Delegated Credentials">
      <t>To reduce the dependency on external CAs, this document strongly
      recommends the use of delegation credentails <xref
      target="I-D.ietf-tls-subcerts"></xref> to be added to the TLS profile of
      encrypted DNS client and server implementations. A delegated credential
      (DC) is a digitally signed data structure with two semantic fields: a
      validity interval and a public key (along with its associated signature
      algorithm). The signature on the delegated credential indicates a
      delegation from the certificate that is issued to the peer. The private
      key used to sign a credential corresponds to the public key of the
      peer's X.509 end-entity certificate [RFC5280].</t>

      <t>It allows a service in the operator managing the CPE to issue its own
      credentials within the scope of a certificate issued by an external CA.
      These credentials only enable the CPE who is recipient of the delegation
      to terminate connections for names that the CA has authorized.
      Furthermore, this mechanism allows the encrypted DNS forwarder on CPE to
      use modern signature algorithms such as Ed25519 [RFC8032] even if the CA
      does not support them.</t>

      <t>The signature on the delegated credential indicates a delegation from
      the certificate that is issued to service in the operator managing the
      CPE. The private key used to sign a credential corresponds to the public
      key of the service's X.509 end-entity certificate [RFC5280]. The
      delegated credential is cryptographically bound to the service's X.509
      end-entity certificate with which the credential will be used.</t>

      <t><figure anchor="poex1"
          title="An Example use of delegated credentials">
          <artwork><![CDATA[ DNS              DNS Forwarder        Service
Client              (CPE)             (e.g., Managed by ISP)  
  |                   |<--DC distribution->|
  |----ClientHello--->|                    |
  |<---ServerHello----|                    |
  |<---Certificate----|                    |
  |<---CertVerify-----|                    |
  |        ...        |                    |
]]></artwork>
        </figure></t>

      <t>The basic sequence of steps involved is as follows:</t>

      <t><figure anchor="poex3" title="Sequence Diagram">
          <artwork><![CDATA[
+------------+              +---------------+       +---------+
| DNS Client |              | Encrypted DNS |       | Service |
|            |              | forwarder     |       |         |
+------------+              +---------------+       +---------+
      |                            |                      |
      |                            | Mutual Authentication|
      |                            |<-------------------->|
      |                            |                      |
      |                            | Credential(Public Key,
      |                            | time, signature)     |
      |                            |--------------------->|
      |                            |                      |
      |                            | Delegated credential |
      |                            | (signed using public |
      |                            | key)                 |
      |                            |<---------------------|
      |                            |                      |
      | ClientHello and            |                      |
      | delegated_credential extn  |                      |
      |--------------------------->|                      |
      |                            |                      |
      | Certificate and delegated  |                      |
      | credential                 |                      |
      |<---------------------------|                      |
      | /------------------------\ |                      |
      |-|CertVerify (Validate the| |                      |
      | | delegated credential)  | |                      | 
      | \------------------------/ |                      |
      |                            |                      |
]]></artwork>
        </figure></t>

      <t><list style="numbers">
          <t>The DNS client provides an extension in its ClientHello that
          indicates support for delegated credentails.</t>

          <t>The DNS forwarder sends the Certificate message providing both
          the certificate of the service as well as the delegated
          credential.</t>

          <t>The DNS client uses information from the certificate to verify
          the delegated credential and that the DNS forwarder is asserting an
          expected identity.</t>
        </list></t>
    </section>

    <section anchor="Legacy" title="Legacy DNS clients">
      <t>In order to support DNS clients which do not support delegation
      credentails or TLS 1.3 or later, server-side mechanisms that do not
      require changes to client behavior are required (e.g., a PKCS#11
      interface or a remote signing mechanism, <xref target="KEYLESS"></xref>
      being one example) as discussed in Section 3.2 of <xref
      target="I-D.ietf-tls-subcerts"></xref>. A DNS forwarder could use
      delegated credentials for DNS clients that support them, while using a
      server-side mechanism to support legacy DNS clients. </t>

      <t><figure anchor="poex2" title="An Example of Remote key signing">
          <artwork><![CDATA[ DNS              DNS Forwarder        Service
Client              (CPE)             (e.g., Managed by ISP)  
  |                   |                    |
  |----ClientHello--->|                    |
  |<---ServerHello----|                    |
  |<---Certificate----|                    |
  |                   |<---remote sign---->|
  |<---CertVerify-----|                    |
  |        ...        |                    |
]]></artwork>
        </figure></t>
    </section>

    <section anchor="Security" title="Security Considerations">
      <t>DNR-related security considerations are discussed in <xref
      section="7" target="I-D.ietf-add-dnr"></xref>. Likewise, DDR-related
      security considerations are discussed in <xref section="7"
      target="I-D.ietf-add-ddr"></xref>. The security considerations in <xref
      target="I-D.ietf-tls-subcerts"></xref> are to be taken into account.</t>

      <t>Delegated credentials allow a CPE to terminate (D)TLS connections on
      behalf of the service in the operator managing the CPE. If a delegated
      credential is stolen, there is no mechanism for revoking it without
      revoking the certificate itself. To limit exposure in case of the
      compromise of a delegated credential's private key, delegated
      credentials must have a maximum validity period of 7 days.</t>

      <t>The operator of the CPE can leverage the Remote Integrity
      Verification (RIV) mechanism discussed in <xref
      target="I-D.ietf-rats-tpm-based-network-device-attest"></xref> to verify
      that the CPE installed at the customer's site is authentic and has been
      configured with authorized software. If evidence shows known bad or
      unknown software configurations, the CPE will not be issued delegated
      credentails.</t>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>This document does not require any IANA action.</t>
    </section>

    <section title="Acknowledgements">
      <t>TODO</t>
    </section>
  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <references title="Normative References">
      <?rfc include='reference.I-D.ietf-add-dnr.xml' ?>

      <?rfc include='reference.I-D.ietf-add-ddr.xml' ?>

      <?rfc include='reference.I-D.ietf-tls-subcerts.xml' ?>
    </references>

    <references title="Informative References">
      <?rfc include='reference.RFC.6890.xml'?>

      <?rfc include='reference.RFC.6598.xml'?>

      <?rfc include='reference.RFC.8190.xml'?>

      <?rfc include='reference.RFC.1918.xml'?>

      <?rfc include='reference.RFC.4192.xml'?>

      <?rfc include='reference.RFC.8499.xml'?>

      <?rfc include='reference.RFC.8520.xml'?>

      <?rfc include='reference.RFC.8555.xml'?>

      <?rfc include='reference.RFC.7858.xml'?>

      <?rfc include='reference.RFC.8484.xml'?>

      <?rfc include='reference.RFC.9250.xml'?>

      <?rfc include='reference.RFC.8585.xml' ?>

      <?rfc include='reference.I-D.ietf-rats-tpm-based-network-device-attest.xml'?>

      <reference anchor="TR-069"
                 target="https://www.broadband-forum.org/technical/download/TR-069.pdf">
        <front>
          <title>CPE WAN Management Protocol</title>

          <author fullname="The Broadband Forum" initials=""
                  surname="The Broadband Forum">
            <organization></organization>
          </author>

          <date month="December" year="2018" />
        </front>
      </reference>

      <reference anchor="KEYLESS" target="">
        <front>
          <title>Sullivan, N. and D. Stebila, "An Analysis of TLS Handshake
          Proxying", IEEE Trustcom/BigDataSE/ISPA 2015 , 2015</title>

          <author fullname="" initials="" surname="">
            <organization></organization>
          </author>

          <date month="December" year="2018" />
        </front>
      </reference>

      <reference anchor="prpl" target="https://prplfoundation.org/">
        <front>
          <title>Prpl Foundation</title>

          <author fullname="" initials="" surname="">
            <organization></organization>
          </author>

          <date month="" year="" />
        </front>
      </reference>

      <reference anchor="prplwrt"
                 target="https://prplfoundation.org/project/prplwrt/">
        <front>
          <title>Prpl WRT</title>

          <author fullname="" initials="" surname="">
            <organization></organization>
          </author>

          <date month="" year="" />
        </front>
      </reference>

      <reference anchor="openwrt" target="https://openwrt.org/">
        <front>
          <title>OpenWrt </title>

          <author fullname="" initials="" surname="">
            <organization></organization>
          </author>

          <date month="" year="" />
        </front>
      </reference>
    </references>
  </back>
</rfc>
