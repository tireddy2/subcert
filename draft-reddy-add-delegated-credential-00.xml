<?xml version="1.0" encoding="US-ASCII"?>
<!-- This template is for creating an Internet Draft using xml2rfc,
     which is available here: http://xml.resource.org. -->
<?xml-stylesheet type='text/xsl' href='rfc2629.xslt' ?>
<!-- used by XSLT processors -->
<!-- For a complete list and description of processing instructions (PIs), 
     please see http://xml.resource.org/authoring/README.html. -->
<!-- Below are generally applicable Processing Instructions (PIs) that most I-Ds might want to use.
     (Here they are set differently than their defaults in xml2rfc v1.32) -->
<?rfc strict="yes" ?>
<!-- give errors regarding ID-nits and DTD validation -->
<!-- control the table of contents (ToC) -->
<?rfc toc="yes"?>
<!-- generate a ToC -->
<?rfc tocdepth="4"?>
<!-- the number of levels of subsections in ToC. default: 3 -->
<!-- control references -->
<?rfc symrefs="yes"?>
<!-- use symbolic references tags, i.e, [RFC2119] instead of [1] -->
<?rfc sortrefs="yes" ?>
<!-- sort the reference entries alphabetically -->
<!-- control vertical white space 
     (using these PIs as follows is recommended by the RFC Editor) -->
<?rfc compact="yes" ?>
<!-- do not start each main section on a new page -->
<?rfc subcompact="no" ?>
<!-- keep one blank line between list items -->
<!-- end of list of popular I-D processing instructions -->
<rfc category="info" docName="draft-reddy-add-delegated-credentials-00"
     ipr="trust200902" submissionType="independent">
  <front>
    <title abbrev="Delegated Credentials for encrypted DNS ">Delegated
    credentials to host encrypted DNS forwarders on CPEs</title>

    <author fullname="Tirumaleswar Reddy" initials="T." surname="Reddy">
      <organization>Nokia</organization>

      <address>
        <postal>
          <street></street>

          <city></city>

          <region></region>

          <code></code>

          <country>India</country>
        </postal>

        <email>kondtir@gmail.com</email>
      </address>
    </author>

    <author fullname="Mohamed Boucadair" initials="M." surname="Boucadair">
      <organization>Orange</organization>

      <address>
        <postal>
          <street></street>

          <city>Rennes</city>

          <code>35000</code>

          <country>France</country>
        </postal>

        <email>mohamed.boucadair@orange.com</email>
      </address>
    </author>

    <author fullname="Dan Wing" initials="D." surname="Wing">
      <organization abbrev="Citrix">Citrix Systems, Inc.</organization>

      <address>
        <postal>
          <street></street>

          <country>USA</country>
        </postal>

        <email>dwing-ietf@fuggles.com</email>
      </address>
    </author>

    <author fullname="Neil Cook" initials="N." surname="Cook">
      <organization>Open-Xchange</organization>

      <address>
        <postal>
          <street></street>

          <country>UK</country>
        </postal>

        <email>neil.cook@noware.co.uk</email>
      </address>
    </author>

    <date />

    <abstract>
      <t>This document discusses using delegated credentials for hosting
      encrypted DNS forwarders in Customer Premises Equipment (CPE). This
      document does not intend to provide deployment recommendations, but is
      meant to exemplify how to host encrypted DNS resolvers (e.g.,
      DNS-over-HTTPS, DNS-over-TLS, or DNS-over-QUIC) on managed CPEs by
      reducing the dependency on Certification Authority.</t>
    </abstract>
  </front>

  <middle>
    <section anchor="intro" title="Introduction">
      <t>The current challenges of hosting encrypted resolvers on CPEs is
      discussed in <xref target="forwarder"></xref>.</t>

      <aside><t>Could we move that entire section into the introduction? Or
      is there a fear it is too long for an introduction?</t></aside>
      
      <t>This document discusses using delegated credentias <xref
      target="I-D.ietf-tls-subcerts"></xref> to host encrypted DNS resolvers
      such as DoH <xref target="RFC8484"></xref>, DNS-over-TLS (DoT) <xref
      target="RFC7858"></xref>, or DNS-over-QUIC (DoQ) <xref
      target="RFC9250"></xref> in managed Customer Premises Equipment (CPEs)
      by reducing the dependency on Certification Authority (CA). The
      advantage of using delegated credentials on CPEs is that it completely
      removes the dependency on the CAs to provide an PKI certificate for each
      CPE. The entity managing the CPE (e..g, ISP, CPE vendor, Security
      Service Provider) will provision it a with a delegated credential and
      renew the delegated credential before the expiry.</t>

	<t>As discussed in Section 3.2 of <xref target="I-D.ietf-tls-subcerts"></xref>,
	mechanisms like [KEYLESS] can provide backwards compatibility to encrypted
	DNS clients that do not yet support this specification.  Client support
	is indicated in their TLS ClientHello.</t>
	


    </section>

    <section anchor="notation" title="Terminology">
      <t>This document makes use of the terms defined in <xref
      target="RFC8499"></xref>.</t>

      <t>The following additional terms are used: <list style="hanging">
          <t hangText="DHCP:">refers to both DHCPv4 and DHCPv6.</t>

          <t hangText="Do53:">refers to unencrypted DNS.</t>

          <t hangText="DNR:">refers to the Discovery of Network-designated
          Resolvers procedure defined in <xref
          target="I-D.ietf-add-dnr"></xref>.</t>

          <t hangText="DDR:">refers to the Discovery of Designated Resolvers
          procedure defined in <xref target="I-D.ietf-add-ddr"></xref>.</t>

          <t hangText="Encrypted DNS:">refers to a scheme where DNS
          exchanges are transported over an encrypted
          channel. Examples of encrypted DNS are DoH <xref
          target="RFC8484"></xref>, DNS-over-TLS (DoT) <xref
          target="RFC7858"></xref>, and DNS-over-QUIC (DoQ) <xref
          target="RFC9250"></xref>.</t>

	  <!--
              <t hangText="Encrypted DNS options:">refers to the options defined
          in <xref target="I-D.ietf-add-dnr"></xref>.</t>

The above term never seems to appear in the document. Also, it seems too general
a term to have in definition section unless it becomes capitalized or some-such
	  -->
	  
          <t hangText="Managed CPE:">refers to a CPE that is managed by an ISP
          or CPE vendor or Security Service Provider.</t>

          <t hangText="Unmanaged CPE:">refers to a CPE that is not managed by
          an ISP or CPE vendor or Security Service Provider.</t>

          <t hangText="Delegated credential:">The certificate issued by the
          operator as described by <xref target="I-D.ietf-tls-subcerts"></xref>.</t>
        </list></t>
    </section>

    <section title="Scope">
      <t>Scope of this document isan ISP-managed encrypted DNS server deployed
      on customer premise equipment.</t>
    </section>

    <section title="prpl">
      <aside><t>I can't find an obvious home for this 'prpl' discussion</t></aside>
      <t>Home routers are a critical component of the home network,
      and their security is essential to protecting the devices and
      data that are connected to them. For instance, the prpl
      Foundation has developed a number of initiatives to promote home
      router security and hardening. The prpl Foundation has developed
      a number of initiatives to promote home router security and
      hardening. For example, the prplWrt project is an initiative
      that aims to improve the security and performance of open-source
      router firmware, such as OpenWrt. OpenWrt is an open-source
      operating system that is designed to run on a wide range of
      routers and embedded devices. It now includes support for
      containerization technology such as Docker, making it possible
      to run containerized applications on a home router. Further, DNS
      providers have optimized the encrypted DNS forwarder to run in a
      container in home router.</t>
    </section>

    <section anchor="mcpe" title="Deployment of Managed CPE">
      <t>This section discusses deployment models for managed CPE.</t>
      
      <section title="Proxied DNS">
        <t><xref target="proxied"></xref> shows various network setups where
        the CPE embeds a caching encrypted DNS forwarder. <xref
        target="comp"></xref> discusses the applicability of DDR as a function
        of the address used by the CPE for the verification of ownership.</t>

        <t><figure align="center" anchor="proxied"
            title="Proxied Encrypted DNS Sessions">
            <artwork><![CDATA[(a)

                      ,--,--,--.             ,--,--,--.
                   ,-'          `-.       ,-'   ISP    `-.
           Host---(      LAN      CPE----(    DNS Resolver)
             |     `-.          ,-'|      `-.          ,-'
             |        `--'--'--'   |       | `--'--'--'
             |                     |<=DNR=>|     |
             |<========DNR========>|       |     |
             |                     |             | 
             |<=====Encrypted=====>|<=Encrypted=>| 
             |         DNS         |     DNS     | 

(b)

                ,--,--,--.             ,--,--,--.
             ,-'          `-.       ,-'   ISP    `-.      3rd Party
     Host---(      LAN      CPE----(                )--- DNS Resolver
       |     `-.          ,-'|      `-.          ,-'        |
       |        `--'--'--'   |       | `--'--'--'           |
       |                     |       |                      |
       |<========DNR========>|       |                      |
       |                     |                              | 
       |<=====Encrypted=====>|<=========Encrypted DNS======>| 
       |         DNS         |                              | 
]]></artwork>
          </figure></t>

	  <aside><t>In diagram (b), the vertical line extending down
	  from the ISP has nothing connected.  Is that intentional?  I
	  expect the ISP and the CPE still do DNR, like in (a), but
	  points at the 3rdparty DNS resolver?  Not sure, though, so I
	  didn't edit the diagram</t></aside>

	  <t>For all the cases shown in <xref target="proxied"></xref>, the CPE
        advertises itself as the default DNS server to the hosts it serves in
        the LAN. The CPE relies upon DHCP or RA to advertise itself to
        internal hosts as the default encrypted DNS forwarder. When receiving
        a DNS request it cannot handle locally, the CPE forwards the request
        to an upstream encrypted DNS. The upstream encrypted DNS can be hosted
        by the ISP or provided by a third party.</t>

        <t>Such a forwarder presence is required for IPv4 service continuity
        purposes (e.g., Section 3.1 of <xref target="RFC8585"></xref>) or for
        supporting advanced services within a local network (e.g., malware
        filtering, parental control, Manufacturer Usage Description (MUD)
        <xref target="RFC8520"></xref> to only allow intended communications
        to and from an IoT device). When the CPE behaves as a DNS forwarder,
        DNS communications can be decomposed into two legs:<list
            style="symbols">
            <t>The leg between an internal host and the CPE.</t>

            <t>The leg between the CPE and an upstream DNS resolver.</t>
          </list></t>

	  <aside><t>Not sure 'service continutity' is best description of all those
	  services, but I can't think of a better name.</t>
	  <t>Does ".local" (and Bonjour and friends) also require a local CPE-provided
	  DNS server?</t>
	  <t>Overall, it seems all of these reasons to have an on-premise DNS server
	  justify moving all of this paragraph into the Introduction?  Thoughts?</t>
	  </aside>

      </section>
    </section>

    <section anchor="forwarder"
             title="Hosting Encrypted DNS Forwarder in Local Networks">
      <t>This section discusses some deployment challenges to host an
      encrypted DNS forwarder within a local network</t>

      <section anchor="comp" title="DDR/DNR Comparison and Naming Constraints">
        <t>DDR requires proving possession of an IP address, as the DDR
        certificate contains the server's IPv4 and IPv6 addresses and is
        signed by a certificate authority. DDR is constrained to public IP
        addresses because WebPKI certificate authorities will not sign
        special-purpose IP addresses <xref target="RFC6890"></xref>, most
        notably IPv4 private-use <xref target="RFC1918"></xref>, IPv4 shared
        address <xref target="RFC6598"></xref>, or IPv6 <xref
        target="RFC8190">Unique-Local</xref> address space. A tempting
        solution is to use the CPE's WAN IP address for DDR and prove
        possession of that IP address. However, the CPE's WAN IPv4 address
        will not be a public IPv4 address if the CPE is behind another layer
        of NAT (either Carrier Grade NAT (CGN) or another on-premise NAT),
        reducing the success of this mechanism to CPE's WAN IPv6 address. If
        the ISP renumbers the subscriber's network suddenly (rather than slow
        IPv6 renumbering described in <xref target="RFC4192"></xref>)
        encrypted DNS service will be delayed until that new certificate is
        acquired.</t>

        <t>DNR requires proving possession of an FQDN as the encrypted
        resolver's certificate contains the FQDN. The entity (e.g., ISP,
        network administrator) managing the CPE would assign a unique FQDN to
        the CPE. There are two mechanisms for the CPE to obtain the
        certificate for the FQDN: using one of its WAN IP addresses or
        requesting its signed certificate from an Internet-facing server used
        for remote CPE management (e.g., the Auto Configuration Server (ACS)
        in the CPE WAN Management Protocol <xref target="TR-069"></xref>). If
        using a CPE's WAN IP address, the CPE needs a public IPv4 or a global
        unicast IPv6 address together with DNS A or AAAA records pointing to
        that CPE's WAN address to prove possession of the DNS name to obtain a
        WebPKI CA-signed certificate (that is, the CPE fulfills the DNS or
        HTTP challenge discussed in ACME <xref target="RFC8555"></xref>).
        However, a CPE's WAN address will not be a public IPv4 address if the
        CPE is behind another layer of NAT (either a CGN or another on-premise
        NAT), reducing the success of this mechanism to a CPE's WAN IPv6
        address. If the subscribers IPv4 or IPv6 address is included in the
        certificate name (e.g., "dyn-192-0-2-1.example.net") then DNR will
        experience IP renumbering complications identical to DDR, described
        above.</t>


      <aside>
	<t>I moved this out of Introduction, as it was just sort of hanging
	there.  Keeping it for safety, and it seems sort of a useful
	introductory-level summary.  But felt out of place to solel discuss
	DNR in the introduction without an explanation why.  So I'm leaving
	it here in case someone has a better idea for where to place this
	paragraph</t>
	<t>Discovery of Network-designated Resolvers (DNR) <xref
      target="I-D.ietf-add-dnr"></xref> specifies how a local encrypted DNS
      resolver can be discovered by connected hosts by means of DHCP <xref
      target="RFC2132"></xref>, DHCPv6 <xref target="RFC8415"></xref>, and
      IPv6 Router Advertisement (RA) <xref target="RFC4861"></xref> options.
      These options are designed to convey the following information: the DNS
      Authentication Domain Name (ADN), a list of IP addresses, and a set of
      service parameters. The ADN is used as a reference identifier for
      authentication purposes, while the list of IP addresses designate where
      to locate the resolver without relying upon an external resolver. The
      service parameters provide additional information to characterize a DNS
      resolver (e.g., supported encrypted DNS, customized DNS port number, or
      URI Template for DNS-over-HTTPS (DoH)). Such an information is used by a
	  DNS client for DNS resolver selection and session establishment.</t>
      </aside>



      </section>

      <section anchor="forwarder_m" title="Problems with Obtaining CA-Signed Certificates">

	<aside><t>This section still has some redundancies that can be cleaned up.</t></aside>
	
	<t>The DoT/DoH forwarder is hosted on the CPE and provisioned by a
        service (e.g., Orchestrator) in the operator's network.  Each CPE
	has a unique FQDN (e.g., cpe-12345.example.com where 12345 might
	be the customer number or part of the device's serial number).  It
	is important that the FQDN is unique for each subscriber.
	The CPE generates a public and
        private key-pair, builds a certificate signing request (CSR), and
        sends the CSR to a service in the vendor managing the CPE.  On
	receipt of the CSR, the ISP's service can utilize Automatic Certificate Management Environment (ACME) <xref
        target="RFC8555"></xref> 
        to automate certificate management functions such as domain validation
        procedure, certificate issuance, and certificate revocation.</t>

        <t>The challenge with this technique is the service will have
        to communicate with the CA to issue certificates for millions of CPEs. If
        an CA is unable to issue a certificate in time or replace a expired
        certificate, the service would no longer be able to present a valid
        certificate to CPEs. When the service requests certificate issuance
        for a large number of subdomains (i.e., millions of CPEs), it could be
        treated as an attacker by the certificate authorities to overwhelm it.
        Further, the short-lived certificates (e.g., certificates that
        typically expire after 90 days) issued by the CA will have to be
        renewed frequently. </t>

        <t>If an external CA is unable to issue a certificate in time to
        replace a deployed certificate, the service would no longer be able to
        present a valid certificate to CPE. With short-lived certificates,
        there is a smaller window of time to renew a certificates and
        therefore a higher risk that an outage at a CA will negatively affect
        the uptime of the encrypted DNS forwarders on CPEs.</t>

	<t>The former mechanism has the following limitations when ACME
        protocol is used for certificate issuance:<list style="symbols">
            <t>Each CPE would have to create a different account for ordering
            a certificate. When a large scale of CPEs (e.g., millions of
            devices) request certificate issuance for a large number of
            subdomains, it could be treated as an attacker by the certificate
            authorities to overwhelm it.</t>

            <t>The CPE would have to host an Internet-facing HTTP server or a
            DNS authoritative server to complete the HTTP or DNS
            challenge.</t>
          </list></t>




      </section>
    </section>

    <section anchor="delegated" title="Delegated Credentials">
      <t>To reduce the dependency on external CAs, this document strongly
      recommends the use of delegation credentails <xref
      target="I-D.ietf-tls-subcerts"></xref> to be added to the TLS profile of
      encrypted DNS client and server implementations. A delegated credential
      (DC) is a digitally signed data structure with two semantic fields: a
      validity interval and a public key (along with its associated signature
      algorithm). The signature on the delegated credential indicates a
      delegation from the certificate that is issued to the peer. The private
      key used to sign a credential corresponds to the public key of the
      peer's X.509 end-entity certificate [RFC5280].</t>

      <t>It allows a service in the operator managing the CPE to issue its own
      credentials within the scope of a certificate issued by an external CA.
      These credentials only enable the CPE who is recipient of the delegation
      to terminate connections for names that the CA has authorized.
      Furthermore, this mechanism allows the encrypted DNS forwarder on CPE to
      use modern signature algorithms such as Ed25519 [RFC8032] even if the CA
      does not support them. </t>

      <t>The signature on the delegated credential indicates a delegation from
      the certificate that is issued to service in the operator managing the
      CPE. The private key used to sign a credential corresponds to the public
      key of the service's X.509 end-entity certificate [RFC5280]. The
      delegated credential is cryptographically bound to the service's X.509
      end-entity certificate with which the credential will be used. </t>

      <t><figure anchor="poex1"
          title="An Example use of delegated credentials">
          <artwork><![CDATA[ DNS              DNS Forwarder        Service
Client              (CPE)             (e.g., Managed by ISP)  
  |                   |<--DC distribution->|
  |----ClientHello--->|                    |
  |<---ServerHello----|                    |
  |<---Certificate----|                    |
  |<---CertVerify-----|                    |
  |        ...        |                    |
]]></artwork>
        </figure></t>


      <t><figure anchor="poex2" title="An Example of Remote key signing">
        <artwork><![CDATA[
 DNS              DNS Forwarder        Service
Client              (CPE)             (e.g., Managed by ISP)  
  |                   |                    |
  |----ClientHello--->|                    |
  |<---ServerHello----|                    |
  |<---Certificate----|                    |
  |                   |<---remote sign---->|
  |<---CertVerify-----|                    |
  |        ...        |                    |
]]></artwork>
        </figure></t>

      <t>The basic sequence of steps involved is as follows:</t>

      <t><figure anchor="poex3" title="Sequence Diagram">
          <artwork><![CDATA[
+------------+              +---------------+       +---------+
| DNS Client |              | Encrypted DNS |       | Service |
|            |              | forwarder     |       |         |
+------------+              +---------------+       +---------+
      |                            |                      |
      |                            | Mutual Authentication|
      |                            |<-------------------->|
      |                            |                      |
      |                            | Credential (Public Key,
      |                            | time, signature)     |
      |                            |--------------------->|
      |                            |                      |
      |                            | Delegated credential |
      |                            | (signed using public |
      |                            | key)                 |
      |                            |<---------------------|
      |                            |                      |
      | ClientHello and            |                      |
      | delegated_credential extn  |                      |
      |--------------------------->|                      |
      |                            |                      |
      | Certificate and delegated  |                      |
      | credential                 |                      |
      |<---------------------------|                      |
      | /------------------------\ |                      |
      |-|CertVerify (Validate the| |                      |
      | | delegated credential)  | |                      | 
      | \------------------------/ |                      |
      |                            |                      |
]]></artwork>
        </figure></t>

      <t><list style="numbers">
          <t>The DNS client provides an extension in its ClientHello that
          indicates support for delegated credentails.</t>

          <t>The DNS forwarder sends the Certificate message providing both
          the certificate of the service as well as the delegated
          credential.</t>

          <t>The DNS client uses information from the certificate to verify
          the delegated credential and that the DNS forwarder is asserting an
          expected identity. </t>
        </list></t>
    </section>

    <section anchor="Security" title="Security Considerations">
      <t>DNR-related security considerations are discussed in <xref
      section="7" target="I-D.ietf-add-dnr"></xref>. Likewise, DDR-related
      security considerations are discussed in <xref section="7"
      target="I-D.ietf-add-ddr"></xref>. The security considerations in <xref
      target="I-D.ietf-tls-subcerts"></xref> are to be taken into account.</t>

      <t>Delegated credentials allow a CPE to terminate (D)TLS connections on
      behalf of the service in the operator managing the CPE. If a credential
      is stolen, there is no mechanism for revoking it without revoking the
      certificate itself. To limit exposure in case of the compromise of a
      delegated credential's private key, delegated credentials must have a
      maximum validity period of 7 days. </t>

      <aside><t>The above paragraph is confusing to Dan.  When it says 'a credential
      is stolen', it needs more precision:  it is referring to a private key?
      And which entity's private key, specifically -- to the CPE's private key
      or to the CA's private key?  That is, if "Alice" has her private key compromised,
      does that have any impact to "Bob"?  Seems not.  If the ISP's private key
      associated with subcert is stolen, that seems to require a new certificate and
      new subcert for all users -- and the 7 day rotation has no bearing on such a
      situation.</t>
      
      <t>Seems we also need "Unique FQDNs are required, otherwise ___"?</t>

      <t>If there is another
      user "Carol", what benefit of "limited exposure" does Carol achieve if Carol's
      delegated credentials, on her CPE, are only 7 days?  I mean, whatever caused
      the theft of her private key may well persist and occur again when Carol gets
      a new certificate, right?  Seems worth discussing that, as well, as refreshing
      Carol's subcert only helps with a one-off theft of Carol's private key</t></aside>
      
      <t>The operator of the CPE can leverage the Remote Integrity
      Verification (RIV) mechanism discussed in <xref
      target="I-D.ietf-rats-tpm-based-network-device-attest"></xref> to verify
      that the CPE installed at the customer's site is authentic and has been
      configured with authorized software.</t>
    </section>

    <section anchor="IANA" title="IANA Considerations">
      <t>This document does not require any IANA action.</t>
    </section>

    <section title="Acknowledgements">
      <t>TODO</t>
    </section>
  </middle>

  <!--  *****BACK MATTER ***** -->

  <back>
    <references title="Normative References">
      <?rfc include='reference.I-D.ietf-add-dnr.xml' ?>

      <?rfc include='reference.I-D.ietf-add-ddr.xml' ?>

      <?rfc include='reference.I-D.ietf-tls-subcerts.xml' ?>

      <?rfc include='reference.I-D.ietf-rats-tpm-based-network-device-attest.xml'?>
    </references>

    <references title="Informative References">
      <?rfc include='reference.RFC.6890.xml'?>

      <?rfc include='reference.RFC.6598.xml'?>

      <?rfc include='reference.RFC.8190.xml'?>

      <?rfc include='reference.RFC.1918.xml'?>

      <?rfc include='reference.RFC.4192.xml'?>

      <?rfc include='reference.RFC.8499.xml'?>

      <?rfc include='reference.RFC.8520.xml'?>

      <?rfc include='reference.RFC.8555.xml'?>

      <?rfc include='reference.RFC.7858.xml'?>

      <?rfc include='reference.RFC.8484.xml'?>

      <?rfc include='reference.RFC.9250.xml'?>

      <?rfc include='reference.RFC.8585.xml' ?>

      <?rfc include='reference.RFC.4861.xml'?>

      <?rfc include='reference.RFC.8415.xml'?>

      <?rfc include='reference.RFC.2132.xml'?>

      <reference anchor="TR-069"
                 target="https://www.broadband-forum.org/technical/download/TR-069.pdf">
        <front>
          <title>CPE WAN Management Protocol</title>

          <author fullname="The Broadband Forum" initials=""
                  surname="The Broadband Forum">
            <organization></organization>
          </author>

          <date month="December" year="2018" />
        </front>
      </reference>
    </references>
  </back>
</rfc>
